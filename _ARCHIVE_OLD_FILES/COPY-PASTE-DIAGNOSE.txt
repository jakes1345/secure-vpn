# ============================================
# COPY-PASTE THIS IN RESCUE MODE (CHROOT)
# Shows you EXACTLY what's wrong
# ============================================

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

echo "=========================================="
echo "üîç DIAGNOSING VPS ISSUES"
echo "=========================================="
echo ""

echo "1Ô∏è‚É£ CURRENT IPTABLES RULES:"
/sbin/iptables -L INPUT -n -v --line-numbers 2>/dev/null || echo "   ‚ùå Cannot list rules"
echo ""
echo "   SSH Rule Check:"
/sbin/iptables -L INPUT -n | grep -E "22|ssh" && echo "   ‚úÖ SSH rule EXISTS" || echo "   ‚ùå SSH rule MISSING!"
echo ""

echo "2Ô∏è‚É£ UFW STATUS:"
if [ -f /etc/ufw/ufw.conf ]; then
    cat /etc/ufw/ufw.conf
    grep -q "ENABLED=no" /etc/ufw/ufw.conf && echo "   ‚úÖ UFW DISABLED" || echo "   ‚ùå UFW ENABLED (BAD!)"
else
    echo "   ‚ö†Ô∏è  UFW config not found"
fi
echo ""

echo "3Ô∏è‚É£ SSH SERVICE:"
if [ -f /etc/ssh/sshd_config ]; then
    echo "   ‚úÖ SSH config exists"
    grep -E "^Port|^PermitRootLogin|^PasswordAuthentication" /etc/ssh/sshd_config || echo "   Using defaults"
else
    echo "   ‚ùå SSH config MISSING!"
fi
if [ -L /etc/systemd/system/multi-user.target.wants/ssh.service ] || [ -L /etc/systemd/system/multi-user.target.wants/sshd.service ]; then
    echo "   ‚úÖ SSH service ENABLED"
else
    echo "   ‚ùå SSH service NOT ENABLED"
fi
echo ""

echo "4Ô∏è‚É£ DNS CONFIG:"
cat /etc/resolv.conf 2>/dev/null || echo "   ‚ùå resolv.conf missing"
echo ""

echo "5Ô∏è‚É£ BOOT SCRIPTS:"
[ -f /etc/network/if-pre-up.d/iptables-load ] && echo "   ‚úÖ Network script exists" || echo "   ‚ùå Network script missing"
[ -f /etc/rc.local ] && echo "   ‚úÖ rc.local exists" || echo "   ‚ùå rc.local missing"
[ -f /etc/systemd/system/ssh-firewall-fix.service ] && echo "   ‚úÖ Systemd service exists" || echo "   ‚ùå Systemd service missing"
echo ""

echo "6Ô∏è‚É£ RULES FILE:"
if [ -f /etc/iptables/rules.v4 ]; then
    echo "   ‚úÖ Rules file exists"
    grep -E "22|ssh" /etc/iptables/rules.v4 && echo "   ‚úÖ SSH rule in file" || echo "   ‚ùå SSH rule NOT in file"
else
    echo "   ‚ùå Rules file MISSING (rules won't persist!)"
fi
echo ""

echo "=========================================="
echo "üìã SUMMARY"
echo "=========================================="
echo ""
echo "Issues found:"
/sbin/iptables -L INPUT -n | grep -q "22\|ssh" || echo "‚ùå SSH rule missing in iptables"
[ -f /etc/ufw/ufw.conf ] && ! grep -q "ENABLED=no" /etc/ufw/ufw.conf && echo "‚ùå UFW is enabled (will conflict)"
[ ! -f /etc/iptables/rules.v4 ] && echo "‚ùå Rules file missing"
[ ! -L /etc/systemd/system/multi-user.target.wants/ssh.service ] && [ ! -L /etc/systemd/system/multi-user.target.wants/sshd.service ] && echo "‚ùå SSH service not enabled"
echo ""
echo "If issues found, run CHROOT-FINAL-FIX.txt to fix everything"
echo ""

