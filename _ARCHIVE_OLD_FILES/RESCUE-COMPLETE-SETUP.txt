# ============================================
# RUN COMPLETE SETUP IN RESCUE MODE
# This fixes EVERYTHING before reboot
# ============================================

# Step 1: Mount (standard)
lsblk
mkdir -p /mnt/recovery
mount /dev/sda1 /mnt/recovery
mount --bind /dev /mnt/recovery/dev
mount --bind /proc /mnt/recovery/proc
mount --bind /sys /mnt/recovery/sys

# Step 2: Chroot
chroot /mnt/recovery

# Step 3: Set PATH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Step 4: Disable UFW (this is the key - it was conflicting!)
/sbin/iptables -F
/sbin/iptables -X
/sbin/iptables -t nat -F
/sbin/iptables -t nat -X
/sbin/iptables -P INPUT ACCEPT
/sbin/iptables -P FORWARD ACCEPT
/sbin/iptables -P OUTPUT ACCEPT

# Step 5: Add firewall rules
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 22 -j ACCEPT
/sbin/iptables -A INPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 443 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT
/sbin/iptables -A INPUT -p udp --dport 1194 -j ACCEPT
/sbin/iptables -A INPUT -p icmp -j ACCEPT
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP

# Step 6: Fix DNS permanently (disable systemd-resolved)
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
chattr +i /etc/resolv.conf 2>/dev/null || true

# Step 7: Save firewall rules
mkdir -p /etc/iptables
/sbin/iptables-save > /etc/iptables/rules.v4

# Step 8: Install iptables-persistent
apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y iptables-persistent -qq

# Step 9: Create script to load rules on boot (multiple methods)
echo '#!/bin/sh' > /etc/network/if-pre-up.d/iptables
echo '/sbin/iptables-restore < /etc/iptables/rules.v4' >> /etc/network/if-pre-up.d/iptables
chmod +x /etc/network/if-pre-up.d/iptables

# Step 10: Ensure SSH rule on boot (backup method)
cat > /etc/rc.local << 'EOF'
#!/bin/bash
/sbin/iptables -I INPUT -p tcp --dport 22 -j ACCEPT 2>/dev/null
/sbin/iptables-save > /etc/iptables/rules.v4 2>/dev/null
exit 0
EOF
chmod +x /etc/rc.local

# Step 11: Disable UFW permanently (so it doesn't conflict)
echo 'ENABLED=no' > /etc/ufw/ufw.conf

# Step 12: Exit and reboot
exit
reboot -f

