# ============================================
# VERIFY EVERYTHING AND FIX WHAT'S NEEDED
# Copy-paste this on the VPS
# ============================================

echo "=========================================="
echo "ğŸ” VERIFYING EVERYTHING"
echo "=========================================="
echo ""

echo "1ï¸âƒ£ DNS (Should be fixed)"
echo "----------------------------------------"
cat /etc/resolv.conf
nslookup google.com 2>/dev/null | head -3 || echo "DNS test - check manually"
echo ""

echo "2ï¸âƒ£ OPENVPN STATUS"
echo "----------------------------------------"
ps aux | grep openvpn | grep -v grep
echo ""
echo "Checking if OpenVPN is listening on port 1194:"
ss -ulnp 2>/dev/null | grep 1194 || netstat -ulnp 2>/dev/null | grep 1194
echo ""

echo "3ï¸âƒ£ OPENVPN CONFIG"
echo "----------------------------------------"
echo "Current OpenVPN process:"
ps aux | grep openvpn | grep -v grep | awk '{print $NF}'
echo ""
echo "Checking config file location:"
OPENVPN_PID=$(pgrep -x openvpn)
if [ -n "$OPENVPN_PID" ]; then
    echo "OpenVPN PID: $OPENVPN_PID"
    ls -la /proc/$OPENVPN_PID/cwd 2>/dev/null | awk '{print "Working directory: " $NF}'
    cat /proc/$OPENVPN_PID/cmdline 2>/dev/null | tr '\0' ' ' && echo ""
fi
echo ""

echo "4ï¸âƒ£ FIREWALL (UFW)"
echo "----------------------------------------"
ufw status numbered
echo ""

echo "5ï¸âƒ£ WEB PORTAL"
echo "----------------------------------------"
ps aux | grep -E 'python.*app.py|flask|8081' | grep -v grep
echo ""
echo "Testing web portal:"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:8081 2>/dev/null || echo "Web portal not responding"
echo ""

echo "6ï¸âƒ£ NGINX"
echo "----------------------------------------"
systemctl status nginx 2>&1 | head -5
echo ""

echo "7ï¸âƒ£ CERTIFICATES"
echo "----------------------------------------"
ls -la /opt/secure-vpn/certs/*.crt 2>/dev/null | head -5
ls -la /opt/secure-vpn/certs/*.key 2>/dev/null | head -3
ls -la /opt/secure-vpn/certs/*.pem 2>/dev/null | head -3
echo ""

echo "8ï¸âƒ£ LISTENING PORTS SUMMARY"
echo "----------------------------------------"
ss -tlnp 2>/dev/null | grep -E ':22|:80|:443|:1194|:8081|:5000' || netstat -tlnp 2>/dev/null | grep -E ':22|:80|:443|:1194|:8081|:5000'
echo ""

echo "=========================================="
echo "ğŸ“‹ SUMMARY"
echo "=========================================="
echo ""

# Check each service
[ -f /etc/resolv.conf ] && grep -q "8.8.8.8" /etc/resolv.conf && echo "âœ… DNS: Fixed" || echo "âŒ DNS: Not fixed"
pgrep -x openvpn >/dev/null && echo "âœ… OpenVPN: Running" || echo "âŒ OpenVPN: Not running"
ss -ulnp 2>/dev/null | grep -q 1194 && echo "âœ… OpenVPN: Listening on 1194" || echo "âŒ OpenVPN: Not listening on 1194"
pgrep -f "python.*app.py\|flask" >/dev/null && echo "âœ… Web Portal: Running" || echo "âŒ Web Portal: Not running"
systemctl is-active nginx >/dev/null && echo "âœ… Nginx: Running" || echo "âŒ Nginx: Not running"
ufw status | grep -q "Status: active" && echo "âœ… Firewall: Active" || echo "âŒ Firewall: Not active"

echo ""
echo "If everything shows âœ…, you're good!"
echo "If you see âŒ, we need to fix those items."
echo ""

