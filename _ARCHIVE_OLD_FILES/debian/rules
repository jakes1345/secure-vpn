#!/usr/bin/make -f
# Debian package build rules

%:
	dh $@

override_dh_auto_install:
	# Install files to package directory
	mkdir -p debian/phaze-vpn/opt/phaze-vpn
	mkdir -p debian/phaze-vpn/etc/systemd/system
	mkdir -p debian/phaze-vpn/usr/share/applications
	mkdir -p debian/phaze-vpn/usr/bin
	mkdir -p debian/phaze-vpn/usr/local/bin
	
	# Copy all files
	cp -r * debian/phaze-vpn/opt/phaze-vpn/ 2>/dev/null || true
	rm -rf debian/phaze-vpn/opt/phaze-vpn/debian
	rm -f debian/phaze-vpn/opt/phaze-vpn/*.deb
	
	# Install standalone executable if it was built
	if [ -f "dist/phazevpn-client" ]; then \
		cp dist/phazevpn-client debian/phaze-vpn/usr/bin/phazevpn-client; \
		chmod +x debian/phaze-vpn/usr/bin/phazevpn-client; \
		echo "✅ Installed standalone executable to /usr/bin/phazevpn-client"; \
	else \
		# Create a wrapper script instead of symlink (more reliable) \
		mkdir -p debian/phaze-vpn/usr/bin; \
		echo '#!/bin/bash' > debian/phaze-vpn/usr/bin/phazevpn-client; \
		echo 'cd /opt/phaze-vpn' >> debian/phaze-vpn/usr/bin/phazevpn-client; \
		echo 'exec python3 /opt/phaze-vpn/vpn-gui.py "$$@"' >> debian/phaze-vpn/usr/bin/phazevpn-client; \
		chmod +x debian/phaze-vpn/usr/bin/phazevpn-client; \
		echo "⚠️  Using Python script wrapper (standalone build not available)"; \
	fi
	
	# Install systemd services (if they exist)
	[ -f debian/phaze-vpn.service ] && cp debian/phaze-vpn.service debian/phaze-vpn/etc/systemd/system/ || true
	[ -f debian/phaze-vpn-download.service ] && cp debian/phaze-vpn-download.service debian/phaze-vpn/etc/systemd/system/ || true
	
	# Install desktop launcher
	cp debian/phaze-vpn.desktop debian/phaze-vpn/usr/share/applications/
	
	# Install icons to system icon directory
	mkdir -p debian/phaze-vpn/usr/share/pixmaps
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-256x256.png debian/phaze-vpn/usr/share/pixmaps/phazevpn.png 2>/dev/null || true
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-128x128.png debian/phaze-vpn/usr/share/pixmaps/phazevpn-128.png 2>/dev/null || true
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-64x64.png debian/phaze-vpn/usr/share/pixmaps/phazevpn-64.png 2>/dev/null || true
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-48x48.png debian/phaze-vpn/usr/share/pixmaps/phazevpn-48.png 2>/dev/null || true
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-32x32.png debian/phaze-vpn/usr/share/pixmaps/phazevpn-32.png 2>/dev/null || true
	cp debian/phaze-vpn/opt/phaze-vpn/assets/icons/phazevpn-16x16.png debian/phaze-vpn/usr/share/pixmaps/phazevpn-16.png 2>/dev/null || true
	
	# Set permissions
	chmod +x debian/phaze-vpn/opt/phaze-vpn/*.sh
	chmod +x debian/phaze-vpn/opt/phaze-vpn/*.py
	chmod +x debian/phaze-vpn/opt/phaze-vpn/scripts/*.sh 2>/dev/null || true

override_dh_auto_build:
	# Build standalone executable using PyInstaller
	@echo "Building standalone executable..."
	@export PATH="$$HOME/.local/bin:$$PATH"; \
	if command -v pyinstaller >/dev/null 2>&1 || [ -f ~/.local/bin/pyinstaller ]; then \
		PYINSTALLER_CMD="$$(command -v pyinstaller || echo ~/.local/bin/pyinstaller)"; \
		echo "Using PyInstaller: $$PYINSTALLER_CMD"; \
		PYINSTALLER_ARGS="--onefile --windowed --name phazevpn-client --hidden-import=tkinter --hidden-import=requests --hidden-import=urllib3 --clean"; \
		if [ -d "assets" ]; then \
			PYINSTALLER_ARGS="$$PYINSTALLER_ARGS --add-data assets:assets"; \
		fi; \
		$$PYINSTALLER_CMD $$PYINSTALLER_ARGS vpn-gui.py 2>&1 | grep -v "WARNING" || true; \
		if [ -f "dist/phazevpn-client" ]; then \
			echo "✅ Standalone executable built: dist/phazevpn-client"; \
			ls -lh dist/phazevpn-client; \
		else \
			echo "⚠️  PyInstaller build failed, will use Python script fallback"; \
		fi; \
	else \
		echo "⚠️  PyInstaller not found, will use Python script fallback"; \
	fi

