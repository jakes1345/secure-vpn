# ============================================
# AGGRESSIVE FIX - Ensures SSH Works 100%
# Run this in chroot
# ============================================

# Step 1: Set PATH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Step 2: Disable UFW COMPLETELY
echo 'ENABLED=no' > /etc/ufw/ufw.conf
echo 'ENABLED=no' > /etc/default/ufw
rm -f /etc/ufw/user.rules
rm -f /etc/ufw/user6.rules

# Step 3: Reset iptables
/sbin/iptables -F
/sbin/iptables -X
/sbin/iptables -t nat -F
/sbin/iptables -t nat -X
/sbin/iptables -t mangle -F
/sbin/iptables -t mangle -X

# Step 4: Set ACCEPT first
/sbin/iptables -P INPUT ACCEPT
/sbin/iptables -P FORWARD ACCEPT
/sbin/iptables -P OUTPUT ACCEPT

# Step 5: Add SSH rule FIRST (before anything else)
/sbin/iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
/sbin/iptables -I INPUT 2 -i lo -j ACCEPT
/sbin/iptables -I INPUT 3 -m state --state ESTABLISHED,RELATED -j ACCEPT

# Step 6: Add other rules
/sbin/iptables -A INPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 443 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT
/sbin/iptables -A INPUT -p udp --dport 1194 -j ACCEPT
/sbin/iptables -A INPUT -p icmp -j ACCEPT

# Step 7: Set DROP policy LAST
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP

# Step 8: Fix DNS
rm -f /etc/resolv.conf
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
chattr +i /etc/resolv.conf 2>/dev/null || true

# Step 9: Save rules
mkdir -p /etc/iptables
/sbin/iptables-save > /etc/iptables/rules.v4

# Step 10: Ensure SSH service starts on boot
systemctl enable ssh 2>/dev/null || systemctl enable sshd 2>/dev/null || true

# Step 11: Create aggressive boot script
cat > /etc/rc.local << 'EOF'
#!/bin/bash
# Aggressive SSH fix on boot
/sbin/iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT 2>/dev/null
/sbin/iptables-save > /etc/iptables/rules.v4 2>/dev/null
systemctl start ssh 2>/dev/null || systemctl start sshd 2>/dev/null || true
exit 0
EOF
chmod +x /etc/rc.local

# Step 12: Create systemd service to ensure SSH rule
mkdir -p /etc/systemd/system/ssh-fix.service.d
cat > /etc/systemd/system/ssh-fix.service << 'EOF'
[Unit]
Description=Ensure SSH firewall rule
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c '/sbin/iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT && /sbin/iptables-save > /etc/iptables/rules.v4'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF
systemctl enable ssh-fix.service 2>/dev/null || true

# Step 13: Network script
echo '#!/bin/sh' > /etc/network/if-pre-up.d/iptables
echo '/sbin/iptables-restore < /etc/iptables/rules.v4 2>/dev/null' >> /etc/network/if-pre-up.d/iptables
echo '/sbin/iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT 2>/dev/null' >> /etc/network/if-pre-up.d/iptables
chmod +x /etc/network/if-pre-up.d/iptables

# Step 14: Verify
echo ""
echo "=== VERIFICATION ==="
/sbin/iptables -L INPUT -n -v | head -10
echo ""
echo "SSH rule check:"
/sbin/iptables -L INPUT -n | grep "tcp dpt:22" && echo "✅ SSH rule exists" || echo "❌ SSH rule missing!"

echo ""
echo "=== DONE ==="
echo "Exit and reboot:"
echo "  exit"
echo "  reboot -f"

