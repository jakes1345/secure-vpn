<!DOCTYPE html>
<html>
<head>
    <title>Moderator Support Portal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background: #2b2b2b;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #444;
        }
        .sidebar-header h2 {
            font-size: 18px;
            color: #00bcd4;
        }
        .clients-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .client-item {
            padding: 12px;
            margin: 5px 0;
            background: #333;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .client-item:hover {
            background: #444;
        }
        .client-item.active {
            background: #00bcd4;
            color: #000;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            background: #2b2b2b;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 70%;
        }
        .message.moderator {
            background: #00bcd4;
            color: #000;
            margin-left: auto;
        }
        .message.client {
            background: #444;
            color: #fff;
        }
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .chat-input-area {
            padding: 15px;
            background: #2b2b2b;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background: #00bcd4; color: #000; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-success { background: #4caf50; color: #fff; }
        .remote-control-panel {
            width: 350px;
            background: #2b2b2b;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
        }
        .remote-screen {
            width: 100%;
            height: 250px;
            background: #000;
            border: 2px solid #444;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-waiting { background: #ff9800; color: #000; }
        .status-active { background: #4caf50; color: #fff; }
        .support-request {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00bcd4;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üí¨ Support Portal</h2>
            <p style="font-size: 12px; color: #aaa; margin-top: 5px;">Moderator Mode</p>
        </div>
        <div class="clients-list" id="clientsList">
            <div style="padding: 10px; color: #aaa; font-size: 12px;">Loading clients...</div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <div>
                <h3 id="currentClient">No client selected</h3>
                <span id="clientStatus" class="status-badge status-waiting">Waiting</span>
            </div>
            <div>
                <button class="btn btn-success" onclick="acceptSupport()">Accept Support</button>
                <button class="btn btn-primary" onclick="requestRemote()">üñ•Ô∏è Remote Control</button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Select a client to start chatting
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="messageInput" 
                       placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    
    <div class="remote-control-panel">
        <h3 style="margin-bottom: 15px;">üñ•Ô∏è Remote Control</h3>
        <div class="remote-screen" id="remoteScreen">
            <div>Remote screen will appear here</div>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" 
                    onclick="startRemoteControl()">Start Remote Control</button>
            <button class="btn btn-danger" style="width: 100%;" 
                    onclick="stopRemoteControl()">Stop Remote Control</button>
        </div>
        <div id="connectionInfo" style="font-size: 12px; color: #aaa;">
            No active connection
        </div>
    </div>
    
    <script>
        const socket = io();
        let currentSession = null;
        let currentClient = null;
        
        socket.on('connect', () => {
            socket.emit('join', {type: 'moderator', username: 'Moderator'});
            loadClients();
        });
        
        socket.on('new_support_request', (data) => {
            loadClients();
        });
        
        socket.on('new_message', (msg) => {
            addMessage(msg);
        });
        
        socket.on('support_accepted', (data) => {
            if (currentSession === data.session_id) {
                document.getElementById('clientStatus').textContent = 'Active';
                document.getElementById('clientStatus').className = 'status-badge status-active';
            }
        });
        
        socket.on('remote_connection_initiated', (data) => {
            document.getElementById('connectionInfo').innerHTML = 
                `Connecting to ${data.vpn_ip}...<br>Port: ${data.port}`;
        });
        
        socket.on('remote_control_active', (data) => {
            document.getElementById('connectionInfo').innerHTML = 
                `‚úÖ Connected to ${data.connection_info.vpn_ip}`;
        });
        
        function loadClients() {
            fetch('/api/clients')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('clientsList');
                    list.innerHTML = '';
                    
                    if (data.clients.length === 0) {
                        list.innerHTML = '<div style="padding: 10px; color: #aaa;">No clients connected</div>';
                        return;
                    }
                    
                    data.clients.forEach(client => {
                        const item = document.createElement('div');
                        item.className = 'client-item';
                        item.innerHTML = `
                            <div style="font-weight: bold;">${client.name}</div>
                            <div style="font-size: 11px; color: #aaa;">${client.vpn_ip}</div>
                        `;
                        item.onclick = () => selectClient(client);
                        list.appendChild(item);
                    });
                });
        }
        
        function selectClient(client) {
            currentClient = client;
            document.getElementById('currentClient').textContent = client.name;
            
            // Remove active class from all items
            document.querySelectorAll('.client-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active to selected
            event.currentTarget.classList.add('active');
            
            // Request support session
            fetch('/api/support/request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    client_name: client.name,
                    vpn_ip: client.vpn_ip,
                    issue: 'Moderator initiated support'
                })
            })
            .then(r => r.json())
            .then(data => {
                currentSession = data.session_id;
                socket.emit('join', {type: 'moderator', session_id: currentSession});
                document.getElementById('chatMessages').innerHTML = '';
            });
        }
        
        function acceptSupport() {
            if (!currentSession) return;
            
            fetch(`/api/support/${currentSession}/accept`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({moderator: 'Moderator'})
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !currentSession) return;
            
            socket.emit('send_message', {
                session_id: currentSession,
                username: 'Moderator',
                message: message,
                type: 'moderator'
            });
            
            input.value = '';
        }
        
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }
        
        function addMessage(msg) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${msg.type}`;
            div.innerHTML = `
                <div class="message-header">${msg.username}</div>
                <div>${msg.message}</div>
            `;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function requestRemote() {
            if (!currentSession || !currentClient) return;
            socket.emit('request_remote_control', {
                session_id: currentSession,
                moderator: 'Moderator'
            });
        }
        
        function startRemoteControl() {
            if (!currentSession || !currentClient) return;
            
            fetch('/api/remote/connect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: currentSession,
                    moderator: 'Moderator',
                    vpn_ip: currentClient.vpn_ip
                })
            });
        }
        
        function stopRemoteControl() {
            document.getElementById('connectionInfo').innerHTML = 'No active connection';
            document.getElementById('remoteScreen').innerHTML = '<div>Remote screen will appear here</div>';
        }
        
        // Auto-refresh clients
        setInterval(loadClients, 5000);
    </script>
</body>
</html>

