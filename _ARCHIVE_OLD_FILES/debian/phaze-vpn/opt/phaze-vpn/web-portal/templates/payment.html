{% extends "base.html" %}

{% block title %}Payment - SecureVPN{% endblock %}

{% block content %}
<h1>ðŸ’³ Upgrade to {{ tier_info.name }}</h1>
<p>Complete your payment to upgrade your subscription</p>

<div class="card" style="max-width: 600px; margin: 2rem auto;">
    <div class="card-header">Payment Details</div>
    <div style="padding: 1.5rem;">
        <div style="margin-bottom: 1.5rem;">
            <strong>Plan:</strong> {{ tier_info.name }}<br>
            <strong>Amount:</strong> ${{ "%.2f"|format(amount) }}<br>
            <strong>Payment ID:</strong> <code style="background: #1a1a1a; padding: 0.25rem 0.5rem; border-radius: 3px;">{{ payment_id }}</code>
        </div>
        
        <div class="alert alert-info">
            <strong>Important:</strong> Include your Payment ID (<code>{{ payment_id }}</code>) in the payment note/memo so we can match your payment!
        </div>
    </div>
</div>

<div class="card" style="max-width: 600px; margin: 2rem auto;">
    <div class="card-header">Payment Methods</div>
    <div style="padding: 1.5rem;">
        
        {% if payment_links.venmo %}
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #4a9eff; margin-bottom: 1rem;">Venmo</h3>
            <p>Click the button below to open Venmo and send payment:</p>
            <a href="{{ payment_links.venmo_mobile }}" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">
                ðŸ“± Pay with Venmo (Mobile)
            </a>
            <a href="{{ payment_links.venmo }}" class="btn btn-secondary" style="width: 100%;">
                ðŸ’» Pay with Venmo (Web)
            </a>
            <p style="color: #b0b0b0; font-size: 0.9rem; margin-top: 0.5rem;">
                Venmo username: <strong>{{ venmo_username }}</strong><br>
                Amount: <strong>${{ "%.2f"|format(amount) }}</strong><br>
                Note: <strong>SecureVPN-{{ payment_id }}</strong>
            </p>
        </div>
        {% endif %}
        
        {% if payment_links.cashapp %}
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #00D632; margin-bottom: 1rem;">CashApp</h3>
            <p>Click the button below to open CashApp and send payment:</p>
            <a href="{{ payment_links.cashapp }}" class="btn btn-success" style="width: 100%; background: #00D632;">
                ðŸ’š Pay with CashApp
            </a>
            <p style="color: #b0b0b0; font-size: 0.9rem; margin-top: 0.5rem;">
                CashApp username: <strong>{{ cashapp_username }}</strong><br>
                Amount: <strong>${{ "%.2f"|format(amount) }}</strong><br>
                Note: <strong>SecureVPN-{{ payment_id }}</strong>
            </p>
        </div>
        {% endif %}
        
        {% if not payment_links.venmo and not payment_links.cashapp %}
        <div class="alert alert-info">
            <strong>Payment methods are being configured.</strong><br>
            Please contact admin for payment instructions.
        </div>
        {% endif %}
        
        {% if stripe_enabled %}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 2px solid #6366f1;">
            <h3 style="color: #6366f1; margin-bottom: 1rem;">ðŸ’³ Credit/Debit Card (Stripe)</h3>
            <p style="margin-bottom: 1rem;">Pay securely with your credit or debit card. Instant activation!</p>
            <button id="stripeCheckoutBtn" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                ðŸ’³ Pay with Card (${{ "%.2f"|format(amount) }})
            </button>
            <p style="color: #b0b0b0; font-size: 0.85rem; margin-top: 0.5rem;">
                Secured by Stripe â€¢ Instant activation â€¢ All major cards accepted
            </p>
        </div>
        
        <script src="https://js.stripe.com/v3/"></script>
        <script>
            const stripe = Stripe('{{ stripe_publishable_key }}');
            const checkoutBtn = document.getElementById('stripeCheckoutBtn');
            
            checkoutBtn.addEventListener('click', async function() {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Processing...';
                
                try {
                    const response = await fetch('/payment/stripe/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            tier: '{{ tier }}'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.checkout_url) {
                        window.location.href = data.checkout_url;
                    } else {
                        alert('Error: ' + (data.error || 'Failed to create checkout session'));
                        checkoutBtn.disabled = false;
                        checkoutBtn.textContent = 'ðŸ’³ Pay with Card (${{ "%.2f"|format(amount) }})';
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'ðŸ’³ Pay with Card (${{ "%.2f"|format(amount) }})';
                }
            });
        </script>
        {% endif %}
        
    </div>
</div>

<div class="card" style="max-width: 600px; margin: 2rem auto;">
    <div class="card-header">Submit Payment Proof</div>
    <div style="padding: 1.5rem;">
        <p>After sending payment, submit your transaction details below:</p>
        
        <form id="paymentProofForm">
            <input type="hidden" id="payment_id" value="{{ payment_id }}">
            
            <div style="margin-bottom: 1rem;">
                <label for="payment_method" style="display: block; margin-bottom: 0.5rem;">Payment Method:</label>
                <select id="payment_method" required style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 4px; color: #e0e0e0;">
                    <option value="">Select payment method</option>
                    {% if payment_links.venmo %}<option value="venmo">Venmo</option>{% endif %}
                    {% if payment_links.cashapp %}<option value="cashapp">CashApp</option>{% endif %}
                    <option value="paypal">PayPal</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="transaction_id" style="display: block; margin-bottom: 0.5rem;">Transaction ID:</label>
                <input type="text" id="transaction_id" placeholder="Enter transaction ID or reference number" required
                       style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 4px; color: #e0e0e0;">
                <small style="color: #666; font-size: 0.85rem;">You can find this in your payment receipt or transaction history</small>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                âœ… Submit Payment Proof
            </button>
        </form>
        
        <div id="submitResult" style="margin-top: 1rem; display: none;"></div>
    </div>
</div>

<div class="card" style="max-width: 600px; margin: 2rem auto; background: #1a3a5a; border-color: #4a9eff;">
    <div class="card-header" style="color: #4a9eff;">ðŸ“‹ What Happens Next?</div>
    <div style="padding: 1.5rem;">
        <ol style="line-height: 2;">
            <li>Send payment using one of the methods above</li>
            <li>Submit your transaction ID below</li>
            <li>Admin reviews and approves (usually within 24 hours)</li>
            <li>Your subscription is upgraded automatically!</li>
            <li>You'll receive a confirmation email</li>
        </ol>
        <p style="margin-top: 1rem; color: #b0b0b0; font-size: 0.9rem;">
            Questions? Contact support or check your payment status in your dashboard.
        </p>
    </div>
</div>

<script>
document.getElementById('paymentProofForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const payment_id = document.getElementById('payment_id').value;
    const payment_method = document.getElementById('payment_method').value;
    const transaction_id = document.getElementById('transaction_id').value;
    
    if (!payment_method || !transaction_id) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    const btn = e.target.querySelector('button[type="submit"]');
    setLoading(btn, true);
    
    try {
        const response = await fetch('/api/payment/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                payment_id: payment_id,
                payment_method: payment_method,
                transaction_id: transaction_id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('submitResult').innerHTML = `
                <div class="alert alert-success">
                    âœ… ${data.message}<br>
                    <small>Payment ID: ${payment_id}</small>
                </div>
            `;
            document.getElementById('submitResult').style.display = 'block';
            showToast(data.message, 'success');
            
            // Redirect to dashboard after 3 seconds
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 3000);
        } else {
            showToast(data.error || 'Failed to submit payment', 'error');
        }
    } catch (error) {
        showToast('Error submitting payment proof', 'error');
    } finally {
        setLoading(btn, false);
    }
});
</script>
{% endblock %}

