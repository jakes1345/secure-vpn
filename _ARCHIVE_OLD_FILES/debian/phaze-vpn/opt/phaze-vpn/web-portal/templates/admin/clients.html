{% extends "base.html" %}

{% block title %}Client Management - SecureVPN{% endblock %}

{% block content %}
<h1>ğŸ“± Client Management</h1>

<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
        <span>VPN Clients ({{ clients|length }})</span>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="addClient()">â• Add Client</button>
            <button class="btn btn-secondary" onclick="bulkImport()">ğŸ“¥ Bulk Import</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Created</th>
                <th>Download</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="clients-table">
            {% for client in clients %}
            <tr data-client="{{ client.name }}">
                <td>{{ client.name }}</td>
                <td>{{ client.created[:10] }}</td>
                <td>
                    <a href="/download/{{ client.name }}" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">â¬‡ï¸ Download</a>
                    <a href="/qr/{{ client.name }}" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-left: 0.25rem;">ğŸ“± QR Code</a>
                </td>
                <td>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="deleteClient('{{ client.name }}')">ğŸ—‘ï¸ Delete</button>
                </td>
            </tr>
            {% endfor %}
            {% if not clients %}
            <tr>
                <td colspan="4" style="text-align: center; color: #b0b0b0;">No clients yet. Click "Add Client" to create one.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
function addClient() {
    const name = prompt('Enter client name:');
    if (!name || !name.trim()) {
        showToast('Client name required', 'error');
        return;
    }
    
    const btn = event.target;
    setLoading(btn, true);
    
    safeFetch('/api/clients', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name.trim()})
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Client created successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'Failed to create client', 'error');
        }
    })
    .catch(() => {})
    .finally(() => setLoading(btn, false));
}

function bulkImport() {
    const names = prompt('Enter client names (one per line):');
    if (!names || !names.trim()) {
        showToast('Client names required', 'error');
        return;
    }
    
    const clientNames = names.split('\n').map(n => n.trim()).filter(n => n);
    if (clientNames.length === 0) {
        showToast('No valid client names provided', 'error');
        return;
    }
    
    if (!confirm(`Create ${clientNames.length} clients?`)) return;
    
    showToast(`Creating ${clientNames.length} clients...`, 'info');
    
    let created = 0;
    let failed = 0;
    
    Promise.all(clientNames.map(name => 
        fetch('/api/clients', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        }).then(res => res.json())
        .then(data => {
            if (data.success) created++;
            else failed++;
        })
        .catch(() => failed++)
    )).then(() => {
        showToast(`Bulk import complete: ${created} created, ${failed} failed`, 
                  failed === 0 ? 'success' : 'info');
        setTimeout(() => location.reload(), 2000);
    });
}

function deleteClient(name) {
    if (!confirm(`Delete client "${name}"? This cannot be undone.`)) return;
    
    safeFetch(`/api/clients/${name}`, {
        method: 'DELETE'
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Client deleted successfully', 'success');
            const row = document.querySelector(`tr[data-client="${name}"]`);
            if (row) {
                row.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    row.remove();
                    if (document.querySelectorAll('#clients-table tr').length === 1) {
                        location.reload();
                    }
                }, 300);
            }
        } else {
            showToast(data.error || 'Failed to delete client', 'error');
        }
    })
    .catch(() => {});
}
</script>
{% endblock %}

