{% extends "base.html" %}

{% block title %}Admin Dashboard - PhazeVPN{% endblock %}

{% block content %}
<div class="container">
    <div class="hero" style="margin-bottom: 2rem;">
        <h1>ğŸ‘‘ Admin Dashboard</h1>
        <p>Welcome, <strong>{{ username }}</strong>! Manage your VPN server and users.</p>
    </div>

    <!-- VPN Control Card -->
    <div class="card" style="margin-bottom: 2rem; border: 2px solid var(--primary);">
        <div class="card-header">
            <h2 class="card-title">ğŸ”Œ VPN Server Control</h2>
            <p class="text-muted">Control all three VPN protocols: OpenVPN, WireGuard, and PhazeVPN Protocol</p>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <strong>Overall Status:</strong>
                    <div id="vpn-status" style="margin-top: 0.5rem;">
                        <span class="status-badge status-inactive">Checking...</span>
                    </div>
                </div>
                <div id="protocol-status" style="grid-column: span 2;">
                    <strong>Protocol Status:</strong>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <span id="openvpn-status" class="badge badge-primary">OpenVPN: Checking...</span>
                        <span id="wireguard-status" class="badge badge-primary">WireGuard: Checking...</span>
                        <span id="phazevpn-status" class="badge badge-primary">PhazeVPN: Checking...</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button id="start-vpn-btn" class="btn btn-success" onclick="startVPN()">
                    â–¶ï¸ Start All VPNs
                </button>
                <button id="stop-vpn-btn" class="btn btn-danger" onclick="stopVPN()">
                    â¹ï¸ Stop All VPNs
                </button>
                <button id="restart-vpn-btn" class="btn btn-primary" onclick="restartVPN()">
                    ğŸ”„ Restart All VPNs
                </button>
            </div>
            
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <p class="text-muted" style="font-size: 0.9rem;">
                    <strong>Note:</strong> This controls all three VPN protocols on the VPS. Changes take effect immediately.
                </p>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-4" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Clients</h3>
            </div>
            <div class="card-body text-center">
                <div style="font-size: 3rem; font-weight: bold; color: var(--primary);">{{ client_count }}</div>
                <p class="text-muted">Total VPN clients</p>
                <a href="/admin/clients" class="btn btn-primary btn-sm" style="margin-top: 1rem;">Manage</a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Users</h3>
            </div>
            <div class="card-body text-center">
                <div style="font-size: 3rem; font-weight: bold; color: var(--primary);">{{ user_count }}</div>
                <p class="text-muted">Total users</p>
                <a href="/admin/users" class="btn btn-primary btn-sm" style="margin-top: 1rem;">Manage</a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Active Connections</h3>
            </div>
            <div class="card-body text-center">
                <div style="font-size: 3rem; font-weight: bold; color: var(--success);">{{ active_connections }}</div>
                <p class="text-muted">Currently connected</p>
                <a href="/admin/clients" class="btn btn-primary btn-sm" style="margin-top: 1rem;">View</a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Support Tickets</h3>
            </div>
            <div class="card-body text-center">
                <div id="ticket-count" style="font-size: 3rem; font-weight: bold; color: var(--warning);">Loading...</div>
                <p class="text-muted">Open tickets</p>
                <a href="/tickets" class="btn btn-primary btn-sm" style="margin-top: 1rem;">Manage</a>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Quick Actions</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="/admin/clients" class="btn btn-primary">â• Add Client</a>
                <a href="/admin/users" class="btn btn-primary">â• Add User</a>
                <a href="/admin/analytics" class="btn btn-primary">ğŸ“Š Analytics</a>
                <a href="/admin/payments" class="btn btn-primary">ğŸ’³ Payments</a>
                <a href="/tickets" class="btn btn-primary">ğŸ“‹ Support Tickets</a>
            </div>
        </div>
    </div>
</div>

<script>
// Update VPN status with all protocols
function updateVPNStatus() {
    fetch('/api/vpn/status')
        .then(res => res.json())
        .then(data => {
            // Overall status
            const statusEl = document.getElementById('vpn-status');
            if (data.running || (data.protocols && (data.protocols.openvpn?.running || data.protocols.wireguard?.running || data.protocols.phazevpn?.running))) {
                statusEl.innerHTML = '<span class="status-badge status-active">ğŸŸ¢ Active</span>';
            } else {
                statusEl.innerHTML = '<span class="status-badge status-inactive">ğŸ”´ Inactive</span>';
            }
            
            // Protocol-specific status
            if (data.protocols) {
                const openvpnEl = document.getElementById('openvpn-status');
                const wireguardEl = document.getElementById('wireguard-status');
                const phazevpnEl = document.getElementById('phazevpn-status');
                
                if (openvpnEl) {
                    openvpnEl.textContent = `OpenVPN: ${data.protocols.openvpn?.running ? 'ğŸŸ¢ Running' : 'ğŸ”´ Stopped'}`;
                    openvpnEl.className = data.protocols.openvpn?.running ? 'badge badge-success' : 'badge badge-danger';
                }
                
                if (wireguardEl) {
                    wireguardEl.textContent = `WireGuard: ${data.protocols.wireguard?.running ? 'ğŸŸ¢ Running' : 'ğŸ”´ Stopped'}`;
                    wireguardEl.className = data.protocols.wireguard?.running ? 'badge badge-success' : 'badge badge-danger';
                }
                
                if (phazevpnEl) {
                    phazevpnEl.textContent = `PhazeVPN: ${data.protocols.phazevpn?.running ? 'ğŸŸ¢ Running' : 'ğŸ”´ Stopped'}`;
                    phazevpnEl.className = data.protocols.phazevpn?.running ? 'badge badge-success' : 'badge badge-danger';
                }
            }
            
            // Update button states
            const startBtn = document.getElementById('start-vpn-btn');
            const stopBtn = document.getElementById('stop-vpn-btn');
            const restartBtn = document.getElementById('restart-vpn-btn');
            
            const isRunning = data.running || (data.protocols && (data.protocols.openvpn?.running || data.protocols.wireguard?.running || data.protocols.phazevpn?.running));
            
            if (startBtn) startBtn.disabled = isRunning;
            if (stopBtn) stopBtn.disabled = !isRunning;
            if (restartBtn) restartBtn.disabled = !isRunning;
        })
        .catch(err => {
            console.error('Failed to fetch VPN status:', err);
            document.getElementById('vpn-status').innerHTML = '<span class="status-badge status-inactive">âŒ Error</span>';
        });
}

function startVPN() {
    const btn = document.getElementById('start-vpn-btn');
    if (!btn) return;
    
    setLoading(btn, true);
    
    safeFetch('/api/vpn/start', {method: 'POST'})
        .then(data => {
            if (data && data.success) {
                showToast(data.message || 'VPN started successfully', 'success');
                setTimeout(updateVPNStatus, 2000);
            } else {
                showToast(data?.message || 'Failed to start VPN', 'error');
            }
        })
        .catch(err => {
            showToast('Error starting VPN: ' + (err.message || 'Unknown error'), 'error');
        })
        .finally(() => setLoading(btn, false));
}

function stopVPN() {
    if (!confirm('Are you sure you want to stop all VPN services? All active connections will be terminated.')) return;
    
    const btn = document.getElementById('stop-vpn-btn');
    if (!btn) return;
    
    setLoading(btn, true);
    
    safeFetch('/api/vpn/stop', {method: 'POST'})
        .then(data => {
            if (data && data.success) {
                showToast(data.message || 'VPN stopped successfully', 'success');
                setTimeout(updateVPNStatus, 2000);
            } else {
                showToast(data?.message || 'Failed to stop VPN', 'error');
            }
        })
        .catch(err => {
            showToast('Error stopping VPN: ' + (err.message || 'Unknown error'), 'error');
        })
        .finally(() => setLoading(btn, false));
}

function restartVPN() {
    if (!confirm('Are you sure you want to restart all VPN services? This will briefly disconnect all users.')) return;
    
    const btn = document.getElementById('restart-vpn-btn');
    if (!btn) return;
    
    setLoading(btn, true);
    
    safeFetch('/api/vpn/restart', {method: 'POST'})
        .then(data => {
            if (data && data.success) {
                showToast(data.message || 'VPN restarted successfully', 'success');
                setTimeout(updateVPNStatus, 3000);
            } else {
                showToast(data?.message || 'Failed to restart VPN', 'error');
            }
        })
        .catch(err => {
            showToast('Error restarting VPN: ' + (err.message || 'Unknown error'), 'error');
        })
        .finally(() => setLoading(btn, false));
}

// Initialize
updateVPNStatus();
updateTicketCount();
setInterval(updateVPNStatus, 5000);
setInterval(updateTicketCount, 10000);
</script>
{% endblock %}
