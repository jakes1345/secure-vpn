# ============================================
# FIX SSH IN RESCUE MODE - URGENT
# The up-ultimate-security.sh script blocked SSH
# This fixes it permanently
# ============================================

# Step 1: Mount (if not already done)
lsblk
mkdir -p /mnt/recovery
mount /dev/sda1 /mnt/recovery
mount --bind /dev /mnt/recovery/dev
mount --bind /proc /mnt/recovery/proc
mount --bind /sys /mnt/recovery/sys

# Step 2: Chroot
chroot /mnt/recovery

# Step 3: Set PATH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Step 4: Fix firewall - allow SSH
/sbin/iptables -F
/sbin/iptables -X
/sbin/iptables -t nat -F
/sbin/iptables -t nat -X
/sbin/iptables -P INPUT ACCEPT
/sbin/iptables -P FORWARD ACCEPT
/sbin/iptables -P OUTPUT ACCEPT

# Add SSH rule FIRST (highest priority)
/sbin/iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
/sbin/iptables -I INPUT 2 -i lo -j ACCEPT
/sbin/iptables -I INPUT 3 -m state --state ESTABLISHED,RELATED -j ACCEPT

# Add other essential rules
/sbin/iptables -A INPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 443 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT
/sbin/iptables -A INPUT -p udp --dport 1194 -j ACCEPT
/sbin/iptables -A INPUT -p icmp -j ACCEPT

# Set DROP policy last
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP

# Step 5: Fix server.conf - comment out the up/down scripts
/bin/sed -i 's/^up scripts\/up-ultimate-security.sh/# up scripts\/up-ultimate-security.sh/' /opt/secure-vpn/config/server.conf
/bin/sed -i 's/^down scripts\/down-ultimate-security.sh/# down scripts\/down-ultimate-security.sh/' /opt/secure-vpn/config/server.conf
/bin/sed -i 's/^script-security 2/# script-security 2/' /opt/secure-vpn/config/server.conf

# Step 6: Save firewall rules
/bin/mkdir -p /etc/iptables
/sbin/iptables-save > /etc/iptables/rules.v4

# Step 7: Verify SSH rule exists
/sbin/iptables -L INPUT -n | grep "tcp dpt:22" && echo "✅ SSH rule exists" || echo "❌ SSH rule missing!"

# Step 8: Exit and reboot
exit
reboot -f

