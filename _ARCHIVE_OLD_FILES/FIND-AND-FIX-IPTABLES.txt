# ============================================
# FIND IPTABLES AND FIX SSH RULE
# Copy-paste this in chroot
# ============================================

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

echo "=========================================="
echo "ðŸ” FINDING IPTABLES"
echo "=========================================="
echo ""

# Find iptables
echo "Looking for iptables..."
which iptables
whereis iptables
find /usr /sbin /bin -name iptables 2>/dev/null | head -5

# Check if it's in PATH
echo ""
echo "Checking PATH:"
echo $PATH

# Try different locations
echo ""
echo "Trying different locations:"
[ -f /usr/sbin/iptables ] && echo "âœ… Found at /usr/sbin/iptables" || echo "âŒ Not at /usr/sbin/iptables"
[ -f /sbin/iptables ] && echo "âœ… Found at /sbin/iptables" || echo "âŒ Not at /sbin/iptables"
[ -f /usr/bin/iptables ] && echo "âœ… Found at /usr/bin/iptables" || echo "âŒ Not at /usr/bin/iptables"

# Install iptables if missing
echo ""
echo "Installing iptables if missing..."
/usr/bin/apt-get update -qq 2>/dev/null
DEBIAN_FRONTEND=noninteractive /usr/bin/apt-get install -y iptables -qq 2>/dev/null

# Find it again after install
echo ""
echo "Finding iptables after install attempt..."
IPTABLES_PATH=$(which iptables 2>/dev/null || find /usr /sbin /bin -name iptables 2>/dev/null | head -1)

if [ -n "$IPTABLES_PATH" ]; then
    echo "âœ… Found iptables at: $IPTABLES_PATH"
    echo ""
    echo "Using: $IPTABLES_PATH"
    
    # Now use the found path
    echo ""
    echo "=========================================="
    echo "ðŸ”§ ADDING SSH RULE"
    echo "=========================================="
    echo ""
    
    # Reset iptables
    $IPTABLES_PATH -P INPUT ACCEPT 2>/dev/null
    $IPTABLES_PATH -F 2>/dev/null
    $IPTABLES_PATH -X 2>/dev/null
    
    # Add SSH rule
    $IPTABLES_PATH -I INPUT 1 -p tcp --dport 22 -j ACCEPT
    $IPTABLES_PATH -I INPUT 2 -i lo -j ACCEPT
    $IPTABLES_PATH -I INPUT 3 -m state --state ESTABLISHED,RELATED -j ACCEPT
    $IPTABLES_PATH -A INPUT -p udp --dport 53 -j ACCEPT
    $IPTABLES_PATH -A INPUT -p tcp --dport 53 -j ACCEPT
    $IPTABLES_PATH -A INPUT -p tcp --dport 443 -j ACCEPT
    $IPTABLES_PATH -A INPUT -p tcp --dport 80 -j ACCEPT
    $IPTABLES_PATH -A INPUT -p udp --dport 1194 -j ACCEPT
    $IPTABLES_PATH -A INPUT -p icmp -j ACCEPT
    $IPTABLES_PATH -P INPUT DROP
    $IPTABLES_PATH -P FORWARD DROP
    
    # Verify
    echo "Verifying SSH rule:"
    $IPTABLES_PATH -L INPUT -n | grep "22\|ssh" && echo "âœ… SSH rule ADDED!" || echo "âŒ SSH rule NOT added"
    
    # Save rules
    echo ""
    echo "Saving rules..."
    /bin/mkdir -p /etc/iptables
    $IPTABLES_PATH-save > /etc/iptables/rules.v4
    echo "âœ… Rules saved"
    
    # Show final status
    echo ""
    echo "Final iptables status:"
    $IPTABLES_PATH -L INPUT -n --line-numbers | head -10
    
else
    echo "âŒâŒâŒ CRITICAL: Cannot find or install iptables! âŒâŒâŒ"
    echo ""
    echo "This is a serious issue. Let's check what's available:"
    echo ""
    echo "Checking if we're in chroot:"
    ls -la / | head -10
    echo ""
    echo "Checking mounted filesystems:"
    mount | grep -E "dev|proc|sys"
    echo ""
    echo "Checking if apt-get works:"
    /usr/bin/apt-get --version 2>/dev/null || echo "apt-get not working"
fi

echo ""

