#!/bin/bash
# PhazeVPN CLI Client
# Command-line interface for PhazeVPN

PHAZEVPN_GUI="/usr/local/bin/phazevpn-gui"
CONFIG_DIR="$HOME/.config/phazevpn"
CONFIG_FILE="$CONFIG_DIR/config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
show_help() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "       PHAZEVPN CLI"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Usage: phazevpn-cli [command]"
    echo ""
    echo "Commands:"
    echo "  connect       Connect to VPN"
    echo "  disconnect    Disconnect from VPN"
    echo "  status        Show connection status"
    echo "  config        Show configuration"
    echo "  login         Login to PhazeVPN"
    echo "  help          Show this help"
    echo ""
    echo "Examples:"
    echo "  phazevpn-cli connect"
    echo "  phazevpn-cli status"
    echo ""
}

check_status() {
    if pgrep -x "phazevpn-gui" > /dev/null; then
        echo -e "${GREEN}âœ… VPN: CONNECTED${NC}"
        
        # Try to get VPN IP
        VPN_IP=$(ip addr show tun0 2>/dev/null | grep -oP 'inet \K[\d.]+' | head -n1)
        if [ -n "$VPN_IP" ]; then
            echo -e "${BLUE}   IP: $VPN_IP${NC}"
        fi
        
        # Try to get public IP
        PUBLIC_IP=$(curl -s --max-time 3 https://api.ipify.org 2>/dev/null)
        if [ -n "$PUBLIC_IP" ]; then
            echo -e "${BLUE}   Public IP: $PUBLIC_IP${NC}"
        fi
        
        return 0
    else
        echo -e "${RED}âŒ VPN: DISCONNECTED${NC}"
        return 1
    fi
}

connect_vpn() {
    echo "ðŸ” Connecting to PhazeVPN..."
    
    if pgrep -x "phazevpn-gui" > /dev/null; then
        echo -e "${YELLOW}âš ï¸  Already connected${NC}"
        return 0
    fi
    
    if [ ! -f "$PHAZEVPN_GUI" ]; then
        echo -e "${RED}âŒ PhazeVPN not installed${NC}"
        echo "Install from: https://phazevpn.com"
        return 1
    fi
    
    # Start VPN in background
    $PHAZEVPN_GUI --connect &
    
    # Wait for connection
    echo -n "Connecting"
    for i in {1..10}; do
        sleep 1
        echo -n "."
        if pgrep -x "phazevpn-gui" > /dev/null; then
            echo ""
            echo -e "${GREEN}âœ… Connected!${NC}"
            check_status
            return 0
        fi
    done
    
    echo ""
    echo -e "${RED}âŒ Connection failed${NC}"
    return 1
}

disconnect_vpn() {
    echo "ðŸ”“ Disconnecting from PhazeVPN..."
    
    if ! pgrep -x "phazevpn-gui" > /dev/null; then
        echo -e "${YELLOW}âš ï¸  Not connected${NC}"
        return 0
    fi
    
    pkill phazevpn-gui
    sleep 1
    
    if ! pgrep -x "phazevpn-gui" > /dev/null; then
        echo -e "${GREEN}âœ… Disconnected${NC}"
        return 0
    else
        echo -e "${RED}âŒ Failed to disconnect${NC}"
        return 1
    fi
}

show_config() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "       PHAZEVPN CONFIGURATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    if [ -f "$CONFIG_FILE" ]; then
        cat "$CONFIG_FILE"
    else
        echo -e "${YELLOW}âš ï¸  No configuration file found${NC}"
        echo "Config should be at: $CONFIG_FILE"
    fi
    echo ""
}

login_vpn() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "       PHAZEVPN LOGIN"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    read -p "Email: " email
    read -sp "Password: " password
    echo ""
    
    # Create config directory
    mkdir -p "$CONFIG_DIR"
    
    # Save credentials (in production, this should be encrypted!)
    cat > "$CONFIG_FILE" << EOF
{
  "email": "$email",
  "server": "phazevpn.com",
  "protocol": "wireguard",
  "auto_connect": false,
  "dns_leak_protection": true,
  "kill_switch": true
}
EOF
    
    echo -e "${GREEN}âœ… Configuration saved${NC}"
    echo ""
    echo "To connect: phazevpn-cli connect"
}

# Main
case "$1" in
    connect)
        connect_vpn
        ;;
    disconnect)
        disconnect_vpn
        ;;
    status)
        check_status
        ;;
    config)
        show_config
        ;;
    login)
        login_vpn
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}âŒ Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
