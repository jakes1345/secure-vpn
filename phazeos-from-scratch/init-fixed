#!/bin/sh
export PATH=/bin

echo "========================================"
echo "   ðŸš€ PhazeOS Live Boot (Fixed)"
echo "========================================"

# Mount kernel filesystems
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts

# Load kernel modules for CD-ROM and disk support
echo "ðŸ“¦ Loading kernel modules..."
modprobe sr_mod 2>/dev/null || true      # SCSI CD-ROM
modprobe cdrom 2>/dev/null || true       # CD-ROM support
modprobe isofs 2>/dev/null || true       # ISO9660 filesystem
modprobe ata_piix 2>/dev/null || true    # IDE/SATA
modprobe ahci 2>/dev/null || true        # AHCI SATA
modprobe virtio_blk 2>/dev/null || true  # VirtIO (QEMU/KVM)
modprobe virtio_scsi 2>/dev/null || true # VirtIO SCSI

# Wait for devices to appear after loading modules
echo "â³ Waiting for devices (7 seconds)..."
sleep 7

echo ""
echo "ðŸ“‹ Available block devices:"
ls -l /dev/sr* /dev/sd* /dev/vd* /dev/hd* 2>/dev/null || echo "No devices found"
echo ""
echo "Block device list from /proc:"
cat /proc/partitions
echo ""

echo "ðŸ”Ž Searching for boot media..."
FOUND=""

# Try CD-ROM devices first
for dev in /dev/sr0 /dev/sr1 /dev/sr2; do
    [ -e "$dev" ] || continue
    echo "   Trying $dev (CD-ROM)..."
    
    if mount -t iso9660 -o ro "$dev" /cdrom 2>&1; then
        if [ -f /cdrom/live/filesystem.squashfs ]; then
            echo "âœ… Found Live Media on $dev"
            FOUND="yes"
            break
        else
            umount /cdrom 2>/dev/null
        fi
    fi
done

# Try disk devices
if [ -z "$FOUND" ]; then
    for dev in /dev/sda /dev/sdb /dev/vda /dev/vdb /dev/hda; do
        [ -e "$dev" ] || continue
        echo "   Trying $dev (Disk)..."
        
        if mount -t iso9660 -o ro "$dev" /cdrom 2>&1; then
            if [ -f /cdrom/live/filesystem.squashfs ]; then
                echo "âœ… Found Live Media on $dev"
                FOUND="yes"
                break
            else
                umount /cdrom 2>/dev/null
            fi
        fi
    done
fi

if [ -z "$FOUND" ]; then
    echo ""
    echo "âŒ FATAL: Could not find boot media"
    echo ""
    echo "Loaded modules:"
    lsmod 2>/dev/null || echo "Cannot list modules"
    echo ""
    echo "Dropping to emergency shell..."
    exec /bin/sh
fi

echo "ðŸ“‚ Mounting System Layers..."

# Mount SquashFS
if ! mount -t squashfs -o loop /cdrom/live/filesystem.squashfs /run/ro; then
    echo "âŒ Failed to mount squashfs"
    exec /bin/sh
fi

# Mount TmpFS
mount -t tmpfs -o size=50% tmpfs /run/rw
mkdir -p /run/rw/upper /run/rw/work

# Create OverlayFS
echo "âœ¨ Assembling OverlayFS..."
if ! mount -t overlay overlay -o lowerdir=/run/ro,upperdir=/run/rw/upper,workdir=/run/rw/work /new_root; then
    echo "âŒ Failed to mount OverlayFS"
    exec /bin/sh
fi

# Move mounts
echo "âž¡ï¸  Switching Root..."
mkdir -p /new_root/run/initramfs/{cdrom,ro,rw}
mount --move /cdrom /new_root/run/initramfs/cdrom 2>/dev/null || true
mount --move /run/ro /new_root/run/initramfs/ro 2>/dev/null || true
mount --move /run/rw /new_root/run/initramfs/rw 2>/dev/null || true

# Unmount boot filesystems
umount /dev/pts 2>/dev/null || true
umount /dev 2>/dev/null || true
umount /sys 2>/dev/null || true
umount /proc 2>/dev/null || true

# Switch to real system
echo "ðŸŽ‰ Booting PhazeOS..."
exec switch_root /new_root /sbin/init
